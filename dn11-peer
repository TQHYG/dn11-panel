#!/bin/bash
# dn11-peer: dn11 BGP peer 管理脚本（服务器版）
# 用法:
#   dn11-peer add                     交互式添加 peer
#   dn11-peer add --batch [参数...]   批量模式添加 peer
#   dn11-peer edit --batch [参数...]  批量模式编辑 peer

# ==================== 配置区域 ====================
PRIVATE_KEY="CHANGE_ME"
LOCAL_TUNNEL_IP="172.16.80.253"
# ==================================================

# ---------- 子命令解析 ----------
SUBCMD="${1:-}"
shift 2>/dev/null || true

# ---------- 模式处理 ----------
BATCH_MODE=0
if [ "$1" = "--batch" ]; then
    BATCH_MODE=1
    shift
    while [ $# -gt 0 ]; do
        case "$1" in
            --name)         name="$2"; shift 2;;
            --peer-ip)      peer_ip="$2"; shift 2;;
            --pubkey)       peer_pubkey="$2"; shift 2;;
            --endpoint)     endpoint="$2"; shift 2;;
            --asn)          peer_asn="$2"; shift 2;;
            --listen-port)  listen_port="$2"; shift 2;;
            --mtu)          mtu="$2"; shift 2;;
            --keepalive)    keepalive="$2"; shift 2;;
            *) printf '{"status":"error","message":"Unknown argument: %s"}\n' "$1"; exit 1;;
        esac
    done
    # 重定向: fd3=原始stdout(JSON输出), stdout→stderr(日志输出)
    exec 3>&1 1>&2
    die() { printf '{"status":"error","message":"%s"}\n' "$(printf '%s' "$1" | sed 's/"/\\"/g')" >&3; exit 1; }
fi

# ---------- 辅助函数 ----------
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

info() { printf "${GREEN}[INFO]${NC} %s\n" "$1"; }
warn() { printf "${YELLOW}[WARN]${NC} %s\n" "$1"; }
err()  { printf "${RED}[ERROR]${NC} %s\n" "$1"; }
ask()  { printf "${CYAN}[?]${NC} %s" "$1"; }
die()  { err "$1"; exit 1; }

# ---------- 前置检查 ----------
[ "$(id -u)" -eq 0 ] || die "请以 root 身份运行此脚本"
command -v wg-quick    >/dev/null 2>&1 || die "wg-quick 未安装"
command -v firewall-cmd >/dev/null 2>&1 || die "firewall-cmd 未安装"
command -v birdc       >/dev/null 2>&1 || die "birdc 未安装"

# ============================================================
# do_add: 添加新 peer
# ============================================================
do_add() {
# ============================================================
# Step 1: 获取 peer 名称
# ============================================================
if [ "$BATCH_MODE" != 1 ]; then
    while true; do
        ask "请输入 peer 名称（1-6 个小写字母或数字）: "
        read -r name
        if printf '%s' "$name" | grep -qE '^[a-z0-9]{1,6}$'; then
            break
        fi
        warn "名称不合法，请仅使用 1-6 个小写字母或数字"
    done
fi
printf '%s' "$name" | grep -qE '^[a-z0-9]{1,6}$' || die "名称不合法: $name"

IFACE="dn11-${name}"
WG_CONF="/etc/wireguard/${IFACE}.conf"
BIRD_CONF="/etc/bird/ebgp_peers.conf"

[ -f "$WG_CONF" ] && die "配置文件 ${WG_CONF} 已存在，peer '${name}' 可能已添加"

# ============================================================
# Step 2: 获取对端信息
# ============================================================
if [ "$BATCH_MODE" != 1 ]; then
    ask "请输入对端隧道 IP（如 172.16.x.x）: "
    read -r peer_ip

    ask "请输入对端公钥: "
    read -r peer_pubkey

    ask "请输入对端 Endpoint（如 host:port，留空表示对端位于 NAT 后）: "
    read -r endpoint
fi
[ -z "$peer_ip" ] && die "隧道 IP 不能为空"
[ -z "$peer_pubkey" ] && die "公钥不能为空"

# ============================================================
# Step 3: 确定监听端口 & 创建 WireGuard 配置
# ============================================================
existing_ports=$(firewall-cmd --permanent --service=dn11 --get-ports 2>/dev/null || true)
if [ -z "$existing_ports" ]; then
    listen_port=30001
else
    max_port=$(printf '%s\n' $existing_ports | sed 's|/.*||' | sort -n | tail -1)
    listen_port=$((max_port + 1))
fi
info "分配监听端口: ${listen_port}/udp"

# 生成配置文件
{
    printf '[Interface]\n'
    printf 'PrivateKey = %s\n' "$PRIVATE_KEY"
    printf 'ListenPort = %s\n' "$listen_port"
    printf 'PostUp = /sbin/ip addr add dev %%i %s/32 peer %s/32\n' "$LOCAL_TUNNEL_IP" "$peer_ip"
    printf 'Table = off\n'
    printf 'MTU = 1420\n'
    printf '\n'
    printf '[Peer]\n'
    [ -n "$endpoint" ] && printf 'Endpoint = %s\n' "$endpoint"
    printf 'PublicKey = %s\n' "$peer_pubkey"
    printf 'AllowedIPs = 10.0.0.0/8, 100.64.0.0/10, 172.16.0.0/12, 192.168.0.0/16\n'
    if [ -n "$endpoint" ]; then
        printf '#PersistentKeepalive = 16\n'
    else
        printf 'PersistentKeepalive = 16\n'
    fi
} > "$WG_CONF"

chmod 600 "$WG_CONF"
info "WireGuard 配置已写入 ${WG_CONF}"

# ============================================================
# Step 4: 配置防火墙（先开端口，再启动接口）
# ============================================================
info "正在配置防火墙 ..."

firewall-cmd --permanent --service=dn11 --add-port="${listen_port}/udp" \
    || die "添加端口 ${listen_port}/udp 到 dn11 服务失败"
info "已将 ${listen_port}/udp 加入 dn11 服务"

firewall-cmd --permanent --zone=trusted --change-interface="$IFACE" \
    || die "将 ${IFACE} 加入 trusted 区域失败"
info "已将 ${IFACE} 加入 trusted 区域"

firewall-cmd --reload || die "防火墙重载失败"
info "防火墙配置已重载"

# ============================================================
# Step 5: 启动 WireGuard 接口并验证
# ============================================================
info "正在启动接口 ${IFACE} ..."
if ! wg-quick up "$IFACE"; then
    err "接口启动失败，正在回滚 ..."
    # 回滚防火墙
    firewall-cmd --permanent --service=dn11 --remove-port="${listen_port}/udp" >/dev/null 2>&1
    firewall-cmd --permanent --zone=trusted --remove-interface="$IFACE" >/dev/null 2>&1
    firewall-cmd --reload >/dev/null 2>&1
    rm -f "$WG_CONF"
    die "已回滚防火墙配置并删除 ${WG_CONF}，请检查参数后重试"
fi

# 验证接口
if ip link show "$IFACE" >/dev/null 2>&1; then
    info "接口 ${IFACE} 已成功启动"
    systemctl enable wg-quick@"$IFACE" >/dev/null 2>&1 || warn "设置 ${IFACE} 开机自启失败，请手动检查"
    wg show "$IFACE"
else
    die "接口 ${IFACE} 未出现在系统中，请手动排查"
fi

# ============================================================
# Step 6: 配置 BIRD
# ============================================================
[ -f "$BIRD_CONF" ] || die "BIRD 配置文件 ${BIRD_CONF} 不存在"

if [ "$BATCH_MODE" != 1 ]; then
    ask "请输入对端 ASN: "
    read -r peer_asn
fi
[ -z "$peer_asn" ] && die "ASN 不能为空"

cat >> "$BIRD_CONF" << EOF

protocol bgp '${IFACE}' from BGP_peers {
    neighbor ${peer_ip}%'${IFACE}' as ${peer_asn};
    # bfd on;
}
EOF

info "BIRD 邻居配置已追加到 ${BIRD_CONF}"

if birdc configure; then
    info "BIRD 配置已应用"
else
    die "BIRD 配置应用失败，请手动检查 ${BIRD_CONF}"
fi

# ============================================================
# 完成
# ============================================================
printf '\n'
info "=============================="
info " Peer '${name}' 添加完成！"
info " 接口:       ${IFACE}"
info " 监听端口:   ${listen_port}/udp"
info " 对端隧道IP: ${peer_ip}"
[ -n "$endpoint" ] && \
info " Endpoint:   ${endpoint}"
info " ASN:        ${peer_asn}"
info "=============================="

# 批量模式: 输出 JSON 结果到原始 stdout
if [ "$BATCH_MODE" = 1 ]; then
    printf '{"status":"success","message":"Peer %s added successfully","data":{"interface":"%s","listen_port":%d,"peer_ip":"%s","asn":"%s"}}\n' \
        "$name" "$IFACE" "$listen_port" "$peer_ip" "$peer_asn" >&3
fi
} # end do_add

# ============================================================
# do_edit: 编辑已有 peer（仅支持 --batch 模式）
# ============================================================
do_edit() {
    [ "$BATCH_MODE" != 1 ] && die "edit 仅支持 --batch 模式"
    [ -z "$name" ] && die "peer 名称不能为空"

    IFACE="dn11-${name}"
    WG_CONF="/etc/wireguard/${IFACE}.conf"
    BIRD_CONF="/etc/bird/ebgp_peers.conf"

    [ -f "$WG_CONF" ] || die "配置文件 ${WG_CONF} 不存在，peer '${name}' 未找到"

    # ---------- 读取当前配置 ----------
    cur_listen_port=$(grep -i 'ListenPort' "$WG_CONF" | sed 's/^[# ]*//' | awk -F'=' '{print $2}' | tr -d ' ')
    cur_mtu=$(grep -i '^MTU' "$WG_CONF" | awk '{print $NF}')
    cur_pubkey=$(grep -i '^PublicKey' "$WG_CONF" | awk '{print $NF}')
    cur_endpoint=$(grep -i '^Endpoint' "$WG_CONF" | awk '{print $NF}')
    cur_keepalive=$(grep -i '^PersistentKeepalive' "$WG_CONF" | awk '{print $NF}')
    cur_peer_ip=$(grep 'PostUp.*ip addr add' "$WG_CONF" | sed -n 's/.*peer \([0-9.]*\).*/\1/p')

    cur_asn=""
    peer_block=$(grep -A 5 "protocol bgp '${IFACE}'" "$BIRD_CONF" 2>/dev/null)
    if [ -n "$peer_block" ]; then
        cur_asn=$(echo "$peer_block" | grep ' as ' | awk '{print $NF}' | tr -d ';')
    fi

    # ---------- 合并变更（未提供的字段保持不变） ----------
    new_pubkey="${peer_pubkey:-$cur_pubkey}"
    new_endpoint="${endpoint:-$cur_endpoint}"
    new_listen_port="${listen_port:-$cur_listen_port}"
    new_mtu="${mtu:-$cur_mtu}"
    new_peer_ip="${peer_ip:-$cur_peer_ip}"
    new_asn="${peer_asn:-$cur_asn}"

    if [ "$keepalive" = "on" ]; then
        new_keepalive=16
    elif [ "$keepalive" = "off" ]; then
        new_keepalive=""
    else
        new_keepalive="$cur_keepalive"
    fi

    info "正在编辑 peer '${name}' ..."

    # ---------- 停止接口 ----------
    info "正在停止接口 ${IFACE} ..."
    wg-quick down "$IFACE" 2>/dev/null || warn "接口关闭失败，尝试继续"

    # ---------- 更新防火墙端口（如果 ListenPort 变更） ----------
    if [ -n "$cur_listen_port" ] && [ -n "$new_listen_port" ] && [ "$new_listen_port" != "$cur_listen_port" ]; then
        info "正在更新防火墙端口: ${cur_listen_port} -> ${new_listen_port} ..."
        firewall-cmd --permanent --service=dn11 --remove-port="${cur_listen_port}/udp" 2>/dev/null
        firewall-cmd --permanent --service=dn11 --add-port="${new_listen_port}/udp" \
            || die "添加端口 ${new_listen_port}/udp 到 dn11 服务失败"
        firewall-cmd --reload || die "防火墙重载失败"
    fi

    # ---------- 重写 WireGuard 配置 ----------
    {
        printf '[Interface]\n'
        printf 'PrivateKey = %s\n' "$PRIVATE_KEY"
        printf 'ListenPort = %s\n' "$new_listen_port"
        printf 'PostUp = /sbin/ip addr add dev %%i %s/32 peer %s/32\n' "$LOCAL_TUNNEL_IP" "$new_peer_ip"
        printf 'Table = off\n'
        printf 'MTU = %s\n' "${new_mtu}"
        printf '\n'
        printf '[Peer]\n'
        [ -n "$new_endpoint" ] && printf 'Endpoint = %s\n' "$new_endpoint"
        printf 'PublicKey = %s\n' "$new_pubkey"
        printf 'AllowedIPs = 10.0.0.0/8, 100.64.0.0/10, 172.16.0.0/12, 192.168.0.0/16\n'
        if [ -n "$new_keepalive" ]; then
            printf 'PersistentKeepalive = %s\n' "$new_keepalive"
        else
            printf '#PersistentKeepalive = 16\n'
        fi
    } > "$WG_CONF"
    chmod 600 "$WG_CONF"
    info "WireGuard 配置已更新"

    # ---------- 启动接口 ----------
    info "正在启动接口 ${IFACE} ..."
    if ! wg-quick up "$IFACE"; then
        die "接口启动失败，请手动检查 ${WG_CONF}"
    fi
    info "接口 ${IFACE} 已启动"

    # ---------- 更新 BIRD 配置（如果 ASN 或 peer IP 变更） ----------
    if [ "$new_asn" != "$cur_asn" ] || [ "$new_peer_ip" != "$cur_peer_ip" ]; then
        info "正在更新 BIRD 配置 ..."
        sed -i "/^protocol bgp '${IFACE}'/,/^}/c\\
protocol bgp '${IFACE}' from BGP_peers {\\
    neighbor ${new_peer_ip}%'${IFACE}' as ${new_asn};\\
    # bfd on;\\
}" "$BIRD_CONF"
        if birdc configure; then
            info "BIRD 配置已应用"
        else
            warn "BIRD 配置应用失败，请手动检查 ${BIRD_CONF}"
        fi
    fi

    # ---------- 完成 ----------
    info "Peer '${name}' 编辑完成"
    printf '{"status":"success","message":"Peer %s updated successfully"}\n' "$name" >&3
}

# ============================================================
# do_delete: 删除已有 peer（仅支持 --batch 模式）
# ============================================================
do_delete() {
    [ "$BATCH_MODE" != 1 ] && die "delete 仅支持 --batch 模式"
    [ -z "$name" ] && die "peer 名称不能为空"

    IFACE="dn11-${name}"
    WG_CONF="/etc/wireguard/${IFACE}.conf"
    BIRD_CONF="/etc/bird/ebgp_peers.conf"

    [ -f "$WG_CONF" ] || die "配置文件 ${WG_CONF} 不存在，peer '${name}' 未找到"

    info "正在删除 peer '${name}' ..."

    # ---------- 读取当前监听端口（用于清理防火墙） ----------
    cur_listen_port=$(grep -i 'ListenPort' "$WG_CONF" | sed 's/^[# ]*//' | awk -F'=' '{print $2}' | tr -d ' ')

    # ---------- 停止并禁用 WireGuard 接口 ----------
    info "正在停止接口 ${IFACE} ..."
    wg-quick down "$IFACE" 2>/dev/null || warn "接口关闭失败，尝试继续"
    systemctl disable wg-quick@"$IFACE" 2>/dev/null || true
    info "接口 ${IFACE} 已停止并禁用"

    # ---------- 清理防火墙 ----------
    if [ -n "$cur_listen_port" ]; then
        info "正在清理防火墙端口 ${cur_listen_port}/udp ..."
        firewall-cmd --permanent --service=dn11 --remove-port="${cur_listen_port}/udp" 2>/dev/null || true
    fi
    firewall-cmd --permanent --zone=trusted --remove-interface="$IFACE" 2>/dev/null || true
    firewall-cmd --reload || warn "防火墙重载失败"
    info "防火墙配置已清理"

    # ---------- 删除 BIRD 配置 ----------
    if grep -q "protocol bgp '${IFACE}'" "$BIRD_CONF" 2>/dev/null; then
        info "正在删除 BIRD 邻居配置 ..."
        sed -i "/^protocol bgp '${IFACE}'/,/^}/d" "$BIRD_CONF"
        # 清理可能残留的空行
        sed -i '/^$/N;/^\n$/d' "$BIRD_CONF"
        if birdc configure; then
            info "BIRD 配置已应用"
        else
            warn "BIRD 配置应用失败，请手动检查 ${BIRD_CONF}"
        fi
    fi

    # ---------- 删除 WireGuard 配置文件 ----------
    rm -f "$WG_CONF"
    info "已删除 ${WG_CONF}"

    # ---------- 完成 ----------
    info "Peer '${name}' 已删除"
    printf '{"status":"success","message":"Peer %s deleted successfully"}\n' "$name" >&3
}

# ============================================================
# 主入口
# ============================================================
case "$SUBCMD" in
    add)    do_add ;;
    edit)   do_edit ;;
    delete) do_delete ;;
    *)      die "用法: dn11-peer {add|edit|delete} [--batch] [参数...]" ;;
esac