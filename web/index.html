<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DN11 网络调试台</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-sha256@0.11.0/src/sha256.min.js"></script>
    <link href="style.css" rel="stylesheet">
</head>
<body class="bg-light">

<nav class="navbar navbar-expand-lg navbar-dark bg-dark shadow-sm">
    <div class="container-fluid">
        <a class="navbar-brand" href="#"><i class="fa-solid fa-network-wired me-2"></i>DN11 Network Console</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item"><a class="nav-link active" href="#" onclick="switchTab('dashboard')">仪表盘</a></li>
                <li class="nav-item"><a class="nav-link" href="#" onclick="switchTab('bgp')">BGP Peers</a></li>
                <li class="nav-item"><a class="nav-link" href="#" onclick="switchTab('bird')">BIRD路由查询</a></li>
                <li class="nav-item"><a class="nav-link" href="#" onclick="switchTab('routes')">系统路由表</a></li>
                <li class="nav-item"><a class="nav-link" href="#" onclick="switchTab('tools')">网络工具</a></li>
            </ul>
        </div>
    </div>
</nav>

<div class="container mt-4">
    <div id="view-dashboard" class="view-section">
        <h4 class="mb-3"><i class="fa-solid fa-server me-2"></i>系统状态</h4>
        <div class="row" id="bird-status-container">
            <div class="col-12 text-center py-5"><div class="spinner-border text-primary"></div><p>正在获取 BIRD 状态...</p></div>
        </div>

        <h4 class="mt-4 mb-3"><i class="fa-solid fa-link me-2"></i>路由器 ↔ 服务器 连接状态</h4>
        <div class="row" id="link-status-container">
            <div class="col-12 text-center py-4"><div class="spinner-border spinner-border-sm text-primary"></div> 正在检测链路...</div>
        </div>

        <h4 class="mt-4 mb-3"><i class="fa-solid fa-ethernet me-2"></i>接口状态 — 路由器</h4>
        <div class="card shadow-sm mb-4">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0" id="interfaces-table">
                        <thead class="table-dark">
                            <tr><th>接口</th><th>状态</th><th>MTU</th><th>IP地址/信息</th></tr>
                        </thead>
                        <tbody><tr><td colspan="4" class="text-center">加载中...</td></tr></tbody>
                    </table>
                </div>
            </div>
        </div>

        <h4 class="mt-4 mb-3"><i class="fa-solid fa-ethernet me-2"></i>接口状态 — 服务器</h4>
        <div class="card shadow-sm">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0" id="server-interfaces-table">
                        <thead class="table-dark">
                            <tr><th>接口</th><th>状态</th><th>MTU</th><th>IP地址/信息</th></tr>
                        </thead>
                        <tbody><tr><td colspan="4" class="text-center">加载中...</td></tr></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="view-bgp" class="view-section d-none">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4><i class="fa-solid fa-circle-nodes me-2"></i>BGP Peers — 路由器</h4>
            <div class="d-flex gap-2">
                <button class="btn btn-sm btn-outline-dark" onclick="showPeerInfo('router')"><i class="fa-solid fa-id-card"></i> Peer Info</button>
                <button class="btn btn-sm btn-outline-success" onclick="showAddPeerModal('router')"><i class="fa-solid fa-plus"></i> 添加 Peer</button>
                <button class="btn btn-sm btn-outline-primary" onclick="loadPeers()"><i class="fa-solid fa-rotate"></i> 刷新</button>
            </div>
        </div>
        <div class="row" id="peers-container"></div>

        <div class="d-flex justify-content-between align-items-center mb-3 mt-4">
            <h4><i class="fa-solid fa-circle-nodes me-2"></i>BGP Peers — 服务器</h4>
            <div class="d-flex gap-2">
                <button class="btn btn-sm btn-outline-dark" onclick="showPeerInfo('server')"><i class="fa-solid fa-id-card"></i> Peer Info</button>
                <button class="btn btn-sm btn-outline-success" onclick="showAddPeerModal('server')"><i class="fa-solid fa-plus"></i> 添加 Peer</button>
                <button class="btn btn-sm btn-outline-primary" onclick="loadServerPeers()"><i class="fa-solid fa-rotate"></i> 刷新</button>
            </div>
        </div>
        <div class="row" id="server-peers-container"></div>
    </div>

    <div id="view-routes" class="view-section d-none">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4><i class="fa-solid fa-route me-2"></i>路由表</h4>
            <div class="d-flex gap-2">
                <select class="form-select form-select-sm" id="route-node-select" style="width: auto;" onchange="loadRoutes()">
                    <option value="router">路由器 (172.16.80.1)</option>
                    <option value="server">服务器 (172.16.80.250)</option>
                </select>
                <button class="btn btn-sm btn-outline-primary" onclick="loadRoutes()"><i class="fa-solid fa-rotate"></i> 刷新</button>
            </div>
        </div>
        <div class="card shadow-sm">
            <div class="card-body">
                <input type="text" id="route-search" class="form-control mb-3" placeholder="搜索路由 (如: 10.28.0.0)...">
                <div class="table-responsive" style="max-height: 70vh;">
                    <table class="table table-sm table-hover font-monospace" id="routes-table">
                        <thead class="table-light sticky-top">
                            <tr><th>目标网段</th><th>网关/下一跳</th><th>设备</th><th>协议</th><th>其他参数</th></tr>
                        </thead>
                        <tbody id="routes-tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="view-bird" class="view-section d-none">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4><i class="fa-solid fa-binoculars me-2"></i>BIRD路由查询</h4>
        </div>

        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <div class="row g-2">
                    <div class="col-md-3">
                        <select class="form-select" id="lg-node-select">
                            <option value="router">路由器 (172.16.80.1)</option>
                            <option value="server">服务器 (172.16.80.250)</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <input type="text" id="lg-input-ip" class="form-control" placeholder="IP (如 172.16.255.1) 留空显示所有路由">
                    </div>
                    <div class="col-md-3 d-flex align-items-center">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="lg-check-detail">
                            <label class="form-check-label" for="lg-check-detail">详细属性</label>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-primary w-100" onclick="runBirdLG()">查询</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="lg-results"></div>
    </div>

    <div id="view-tools" class="view-section d-none">
        <h4 class="mb-3"><i class="fa-solid fa-toolbox me-2"></i>诊断工具箱</h4>
        
        <ul class="nav nav-tabs" id="toolsTab" role="tablist">
            <li class="nav-item"><a class="nav-link active" id="ping-tab" data-bs-toggle="tab" href="#tool-ping">Ping / TCPing</a></li>
            <li class="nav-item"><a class="nav-link" id="trace-tab" data-bs-toggle="tab" href="#tool-trace">Traceroute</a></li>
            <li class="nav-item"><a class="nav-link" id="dns-tab" data-bs-toggle="tab" href="#tool-dns">NSLookup</a></li>
        </ul>
        
        <div class="tab-content card shadow-sm border-top-0 p-4 bg-white">
            <div class="tab-pane fade show active" id="tool-ping">
                <div class="row g-3 align-items-end">
                    <div class="col-md-2">
                        <label class="form-label">后端节点</label>
                        <!-- 以下名称和地址改为你自己的节点信息 -->
                        <select class="form-select" id="ping-backend">
                            <option value="http://172.16.80.1/cgi-bin/dn11-api">路由器 (172.16.80.1)</option>
                            <option value="http://172.16.80.10/nettools.php">NAS (172.16.80.10)</option>
                            <option value="http://172.16.80.250:18080/dn11-api.php">服务器 (172.16.80.250)</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">模式</label>
                        <select class="form-select" id="ping-mode">
                            <option value="ping">ICMP Ping</option>
                            <option value="tcping">TCPing</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">目标主机</label>
                        <input type="text" class="form-control" id="ping-host" placeholder="1.1.1.1 或 example.com">
                    </div>
                    <div class="col-md-1" id="tcp-port-div" style="display:none;">
                        <label class="form-label">端口</label>
                        <input type="number" class="form-control" id="ping-port" value="443">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">轮询间隔 (ms)</label>
                        <input type="number" class="form-control" id="ping-interval" value="1000" min="200">
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-success w-100" id="btn-start-ping" onclick="togglePing()"><i class="fa-solid fa-play"></i> 开始</button>
                    </div>
                </div>

                <hr>

                <div class="row mt-4">
                    <div class="col-md-4">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6 class="card-title">统计信息</h6>
                                <div class="d-flex justify-content-between mb-2"><span>发送:</span> <span id="stat-sent" class="fw-bold">0</span></div>
                                <div class="d-flex justify-content-between mb-2"><span>接收:</span> <span id="stat-recv" class="fw-bold text-success">0</span></div>
                                <div class="d-flex justify-content-between mb-2"><span>失败:</span> <span id="stat-fail" class="fw-bold text-danger">0</span></div>
                                <div class="d-flex justify-content-between mb-2"><span>丢包率:</span> <span id="stat-loss" class="fw-bold">0%</span></div>
                                <div class="d-flex justify-content-between"><span>平均延迟:</span> <span id="stat-avg" class="fw-bold text-primary">0 ms</span></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <canvas id="pingChart" style="max-height: 250px;"></canvas>
                    </div>
                </div>
                <div class="mt-3">
                    <h6>最新日志</h6>
                    <div id="ping-log" class="bg-dark text-success p-2 font-monospace rounded" style="height: 150px; overflow-y: auto; font-size: 0.85rem;"></div>
                </div>
            </div>

            <div class="tab-pane fade" id="tool-trace">
                <div class="row g-3 mb-3">
                    <div class="col-md-4">
                        <label class="form-label">后端节点</label>
                        <!-- 以下名称和地址改为你自己的节点信息 -->
                        <select class="form-select" id="trace-backend">
                            <option value="http://172.16.80.10/nettools.php">NAS (172.16.80.10)</option>
                            <option value="http://172.16.80.250:18080/dn11-api.php">服务器 (172.16.80.250)</option>
                        </select>
                    </div>
                    <div class="col-md-5">
                        <label class="form-label">目标主机</label>
                        <input type="text" class="form-control" id="trace-host" placeholder="例如: 8.8.8.8">
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                        <button class="btn btn-primary w-100" type="button" id="btn-trace" onclick="startTrace()"><i class="fa-solid fa-route"></i> 开始追踪</button>
                    </div>
                </div>

                <div id="trace-loading" class="d-none text-center my-3">
                    <div class="spinner-grow text-primary" role="status"></div>
                    <div class="spinner-grow text-secondary" role="status"></div>
                    <div class="spinner-grow text-success" role="status"></div>
                    <p class="mt-2 text-muted">正在探测路径，请稍候...</p>
                </div>

                <div class="table-responsive">
                    <table class="table table-hover table-sm mt-3" id="trace-table">
                        <thead class="table-dark">
                            <tr>
                                <th style="width: 50px;">Hop</th>
                                <th>主机名 / IP</th>
                                <th>延迟 1</th>
                                <th>延迟 2</th>
                                <th>延迟 3</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
                <pre id="trace-raw" class="d-none bg-light p-3 border"></pre>
            </div>

            <div class="tab-pane fade" id="tool-dns">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label>后端节点</label>
                        <!-- 以下名称和地址改为你自己的节点信息 -->
                        <select class="form-select" id="dns-backend">
                            <option value="http://172.16.80.1/cgi-bin/dn11-api">路由器 (172.16.80.1)</option>
                            <option value="http://172.16.80.250:18080/dn11-api.php">服务器 (172.16.80.250)</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label>域名 / IP</label>
                        <input type="text" class="form-control" id="dns-host" placeholder="baidu.com">
                    </div>
                    <div class="col-md-3">
                        <label>指定 DNS 服务器 (可选)</label>
                        <input type="text" class="form-control" id="dns-server" placeholder="8.8.8.8">
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button class="btn btn-primary w-100" onclick="doNslookup()">查询</button>
                    </div>
                </div>
                <div class="mt-4" id="dns-result"></div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="peerErrorModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="peerErrorTitle">节点异常详情</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="peerErrorContent" class="font-monospace p-3 bg-light border rounded" style="white-space: pre-wrap; word-break: break-all; font-size: 0.9rem;">
                    </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="peerInfoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title" id="peerInfoTitle">Peer 信息</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="peerInfoContent"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="addPeerModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title" id="addPeerModalTitle">添加 Peer</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Peer 名称</label>
                        <input type="text" class="form-control" id="add-peer-name" maxlength="6" placeholder="1-6位小写字母或数字">
                        <div class="invalid-feedback" id="add-peer-name-fb"></div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">ASN</label>
                        <input type="text" class="form-control" id="add-peer-asn" placeholder="如 4211110122">
                        <div class="invalid-feedback" id="add-peer-asn-fb"></div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">对端隧道 IP</label>
                        <input type="text" class="form-control" id="add-peer-ip" placeholder="172.16.x.x">
                        <div class="invalid-feedback" id="add-peer-ip-fb"></div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Endpoint</label>
                        <input type="text" class="form-control" id="add-peer-endpoint" placeholder="host:port">
                        <div class="invalid-feedback" id="add-peer-endpoint-fb"></div>
                        <div class="form-text" id="add-peer-endpoint-hint"></div>
                    </div>
                    <div class="col-12">
                        <label class="form-label">对端公钥</label>
                        <input type="text" class="form-control font-monospace" id="add-peer-pubkey" placeholder="WireGuard Public Key (44字符 Base64)">
                        <div class="invalid-feedback" id="add-peer-pubkey-fb"></div>
                    </div>
                    <div class="col-12"><hr class="my-1"></div>
                    <div class="col-12">
                        <label class="form-label"><i class="fa-solid fa-key me-1"></i>API 密码</label>
                        <input type="password" class="form-control" id="add-peer-password" placeholder="输入 API 密码">
                        <div class="invalid-feedback" id="add-peer-password-fb"></div>
                    </div>
                </div>
                <div id="add-peer-result" class="mt-3"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="btn-add-peer" onclick="submitAddPeer()">
                    <i class="fa-solid fa-plus me-1"></i>添加
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<div class="modal fade" id="editPeerModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title" id="editPeerModalTitle">编辑 Peer</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Step 1: 密码验证 -->
                <div id="edit-peer-step1">
                    <div class="mb-3">
                        <label class="form-label"><i class="fa-solid fa-key me-1"></i>API 密码</label>
                        <input type="password" class="form-control" id="edit-peer-password" placeholder="输入 API 密码以获取当前配置">
                    </div>
                    <button class="btn btn-primary w-100" onclick="fetchPeerDetail()">
                        <i class="fa-solid fa-download me-1"></i>获取配置
                    </button>
                    <div id="edit-peer-auth-result" class="mt-3"></div>
                </div>
                <!-- Step 2: 编辑表单 -->
                <div id="edit-peer-step2" class="d-none">
                    <div class="row g-3">
                        <div class="col-12">
                            <label class="form-label">对端公钥</label>
                            <input type="text" class="form-control font-monospace" id="edit-peer-pubkey" placeholder="WireGuard Public Key">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">对端隧道 IP</label>
                            <input type="text" class="form-control" id="edit-peer-ip" placeholder="172.16.x.x">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">ASN</label>
                            <input type="text" class="form-control" id="edit-peer-asn" placeholder="如 4211110001">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Endpoint</label>
                            <input type="text" class="form-control" id="edit-peer-endpoint" placeholder="host:port (留空保持不变)">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">ListenPort</label>
                            <input type="number" class="form-control" id="edit-peer-listenport" placeholder="如 30001">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">MTU</label>
                            <input type="number" class="form-control" id="edit-peer-mtu" placeholder="如 1420">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">PersistentKeepalive</label>
                            <select class="form-select" id="edit-peer-keepalive">
                                <option value="on">开启 (16s)</option>
                                <option value="off">关闭</option>
                            </select>
                        </div>
                    </div>
                    <div id="edit-peer-result" class="mt-3"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary d-none" id="btn-save-peer" onclick="submitEditPeer()">
                    <i class="fa-solid fa-save me-1"></i>保存
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="deletePeerModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deletePeerModalTitle">删除 Peer</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning mb-3">
                    <i class="fa-solid fa-triangle-exclamation me-1"></i>
                    <strong>警告：</strong>此操作将删除该 Peer 的所有配置（WireGuard 接口、防火墙规则、BIRD 邻居），且无法撤销！
                </div>
                <p>确定要删除 <strong id="delete-peer-display-name"></strong> 吗？</p>
                <div class="mb-3">
                    <label class="form-label"><i class="fa-solid fa-key me-1"></i>API 密码</label>
                    <input type="password" class="form-control" id="delete-peer-password" placeholder="输入 API 密码以确认删除">
                </div>
                <div id="delete-peer-result"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-danger" id="btn-delete-peer" onclick="submitDeletePeer()">
                    <i class="fa-solid fa-trash me-1"></i>确认删除
                </button>
            </div>
        </div>
    </div>
</div>

<script src="app.js"></script>
</body>
</html>